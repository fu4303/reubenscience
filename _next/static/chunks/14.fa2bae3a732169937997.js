(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[14],{"25nB":function(e,t,a){"use strict";a.r(t),a.d(t,"frameCount",(function(){return U})),a.d(t,"getFrameURL",(function(){return W})),a.d(t,"metadata",(function(){return H})),a.d(t,"default",(function(){return K}));var n=a("rePB"),o=a("Ff2n"),r=a("q1tI"),i=a.n(r);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function p(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?p(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):p(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var m=i.a.createContext({}),u=function(e){var t=i.a.useContext(m),a=t;return e&&(a="function"===typeof e?e(t):l(l({},t),e)),a},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},h=i.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,r=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),p=u(a),m=n,h=p["".concat(r,".").concat(m)]||p[m]||d[m]||o;return a?i.a.createElement(h,l(l({ref:t},s),{},{components:a})):i.a.createElement(h,l({ref:t},s))}));function f(e,t){var a=arguments,n=t&&t.mdxType;if("string"===typeof e||n){var o=a.length,r=new Array(o);r[0]=h;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"===typeof e?e:n,r[1]=s;for(var l=2;l<o;l++)r[l]=a[l];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,a)}h.displayName="MDXCreateElement";var N=a("ck7P"),b=a("nKUr"),g=a("vU6x");function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function w(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e)){var a=[],n=!0,o=!1,r=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(a.push(i.value),!t||a.length!==t);n=!0);}catch(p){o=!0,r=p}finally{try{n||null==s.return||s.return()}finally{if(o)throw r}}return a}}(e,t)||function(e,t){if(e){if("string"===typeof e)return y(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?y(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(){return(v=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var k=new Map,j=new Map,C=0;function O(e){return Object.keys(e).sort().filter((function(t){return void 0!==e[t]})).map((function(t){return t+"_"+("root"===t?(a=e.root)?(j.has(a)||(C+=1,j.set(a,C.toString())),j.get(a)):"0":e[t]);var a})).toString()}function I(e,t,a){if(void 0===a&&(a={}),!e)return function(){};var n=function(e){var t=O(e),a=k.get(t);if(!a){var n,o=new Map,r=new IntersectionObserver((function(t){t.forEach((function(t){var a,r=t.isIntersecting&&n.some((function(e){return t.intersectionRatio>=e}));e.trackVisibility&&"undefined"===typeof t.isVisible&&(t.isVisible=r),null==(a=o.get(t.target))||a.forEach((function(e){e(r,t)}))}))}),e);n=r.thresholds||(Array.isArray(e.threshold)?e.threshold:[e.threshold||0]),a={id:t,observer:r,elements:o},k.set(t,a)}return a}(a),o=n.id,r=n.observer,i=n.elements,s=i.get(e)||[];return i.has(e)||i.set(e,s),s.push(t),r.observe(e),function(){s.splice(s.indexOf(t),1),0===s.length&&(i.delete(e),r.unobserve(e)),0===i.size&&(r.disconnect(),k.delete(o))}}function x(e){return"function"!==typeof e.children}var P=function(e){var t,a;function n(t){var a;return(a=e.call(this,t)||this).node=null,a._unobserveCb=null,a.handleNode=function(e){a.node&&(a.unobserve(),e||a.props.triggerOnce||a.props.skip||a.setState({inView:!!a.props.initialInView,entry:void 0})),a.node=e||null,a.observeNode()},a.handleChange=function(e,t){e&&a.props.triggerOnce&&a.unobserve(),x(a.props)||a.setState({inView:e,entry:t}),a.props.onChange&&a.props.onChange(e,t)},a.state={inView:!!t.initialInView,entry:void 0},a}a=e,(t=n).prototype=Object.create(a.prototype),t.prototype.constructor=t,t.__proto__=a;var o=n.prototype;return o.componentDidUpdate=function(e){e.rootMargin===this.props.rootMargin&&e.root===this.props.root&&e.threshold===this.props.threshold&&e.skip===this.props.skip&&e.trackVisibility===this.props.trackVisibility&&e.delay===this.props.delay||(this.unobserve(),this.observeNode())},o.componentWillUnmount=function(){this.unobserve(),this.node=null},o.observeNode=function(){if(this.node&&!this.props.skip){var e=this.props,t=e.threshold,a=e.root,n=e.rootMargin,o=e.trackVisibility,r=e.delay;this._unobserveCb=I(this.node,this.handleChange,{threshold:t,root:a,rootMargin:n,trackVisibility:o,delay:r})}},o.unobserve=function(){this._unobserveCb&&(this._unobserveCb(),this._unobserveCb=null)},o.render=function(){if(!x(this.props)){var e=this.state,t=e.inView,a=e.entry;return this.props.children({inView:t,entry:a,ref:this.handleNode})}var n=this.props,o=n.children,i=n.as,s=n.tag,p=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(n,["children","as","tag","triggerOnce","threshold","root","rootMargin","onChange","skip","trackVisibility","delay","initialInView"]);return Object(r.createElement)(i||s||"div",v({ref:this.handleNode},p),o)},n}(r.Component);P.displayName="InView",P.defaultProps={threshold:0,triggerOnce:!1,initialInView:!1};function S(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}var M=function(e){var t=e.children,a=e.config,o=t.Client,i=void 0===o?t:o;t.Server;var s=w(function(e){var t=void 0===e?{}:e,a=t.threshold,n=t.delay,o=t.trackVisibility,i=t.rootMargin,s=t.root,p=t.triggerOnce,l=t.skip,c=t.initialInView,m=Object(r.useRef)(),u=Object(r.useState)({inView:!!c}),d=u[0],h=u[1],f=Object(r.useCallback)((function(e){void 0!==m.current&&(m.current(),m.current=void 0),l||e&&(m.current=I(e,(function(e,t){h({inView:e,entry:t}),t.isIntersecting&&p&&m.current&&(m.current(),m.current=void 0)}),{root:s,rootMargin:i,threshold:a,trackVisibility:o,delay:n}))}),[Array.isArray(a)?a.toString():a,s,i,p,l,o,n]);Object(r.useEffect)((function(){m.current||!d.entry||p||l||h({inView:!!c})}));var N=[f,d.inView,d.entry];return N.ref=N[0],N.inView=N[1],N.entry=N[2],N}(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?S(Object(a),!0).forEach((function(t){Object(n.a)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):S(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({triggerOnce:!0,rootMargin:"200px 0px"},a)),2),p=s[0],l=s[1];return Object(b.jsx)(i,{_ref:p,inView:l})};function _(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}var T=function(e){var t=e.image,a=e.className,i=Object(o.a)(e,["image","className"]),s=t.src,p=t.srcSet,l=void 0===p?"":p,c=t.size,m=(c=void 0===c?{}:c).width,u=void 0===m?1e3:m,d=c.height,h=void 0===d?0:d,f=Object(r.useState)(!1),N=f[0],y=f[1];return Object(b.jsx)(M,{children:function(e){var t=e._ref,o=e.inView;return Object(b.jsx)("img",function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?_(Object(a),!0).forEach((function(t){Object(n.a)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):_(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({ref:t,onLoad:function(){return y(!0)},src:o?s:"",srcSet:o?l:"",width:u,height:h,className:N?a:[g.loading,a].join(" "),loading:"lazy"},i))}})},A=a("v8yT");function F(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function V(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?F(Object(a),!0).forEach((function(t){Object(n.a)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):F(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var D=function(e){var t=e.video,a=e.className,n=Object(o.a)(e,["video","className"]),i=t.sources,s=t.size,p=(s=void 0===s?{}:s).width,l=void 0===p?1e3:p,c=s.height,m=void 0===c?0:c,u=Object(r.useState)(!1),d=u[0],h=u[1];return Object(b.jsx)(M,{children:function(e){var t=e._ref,r=e.inView;return Object(b.jsx)("video",V(V({ref:t,onLoadedData:function(){return h(!0)},width:l,height:m,className:d?a:[A.loading,a].join(" ")},n),{},{children:i.map((function(e){var t=e.src,a=Object(o.a)(e,["src"]);return Object(b.jsx)("source",V({src:r?t:null},a),t)}))}),r?1:0)}})},E=a("RujP"),q={size:{width:1e3,height:400},src:"/.assets/8225697f392f56e9e1b65e4cc963bc3c.webp",srcSet:"/.assets/8225697f392f56e9e1b65e4cc963bc3c.webp 1x, /.assets/09d9af82603cfcf70d08ebba1a9259c0.webp 2x"},B={size:{width:414,height:465},src:"/.assets/25a3cd56a2be982cda514ca79883ea57.webp",srcSet:"/.assets/25a3cd56a2be982cda514ca79883ea57.webp 1x, /.assets/5cfe01c8ff3c6994222c6ad102087476.webp 2x"},R={size:{width:842,height:108},src:"/.assets/930f96cfa108a410442418563ee3cac7.webp",srcSet:"/.assets/930f96cfa108a410442418563ee3cac7.webp 1x, /.assets/cb94ff261701a2b4872a0037bbb5e82d.webp 2x"},z={size:{width:388,height:525},src:"/.assets/b98a4b7d7ec1fd17c8bc4073d58e130b.webp",srcSet:"/.assets/b98a4b7d7ec1fd17c8bc4073d58e130b.webp 1x, /.assets/7e4768587a7152dc8324cf3a45bf449d.webp 2x"};function L(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function G(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?L(Object(a),!0).forEach((function(t){Object(n.a)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):L(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var U=Math.floor(105),W=function(e){return"/me-360t/frame-".concat(3*e,".webp")},H={title:"Making My Interactive Memoji",description:"Interactive Memojis for the Web",emoji:"\ud83d\udc66\ud83c\udffb",date:"2020-12-16",category:["dev"]},Z={frameCount:U,metadata:H};function K(e){var t=e.components,a=Object(o.a)(e,["components"]);return f("wrapper",G(G(G({},Z),a),{},{components:t,mdxType:"MDXLayout"}),f("h2",null,"Memoji?"),f("p",null,"Introduced with iOS 12, Memoji is Apple's progression of the ubiquitous emoji. Set apart from its ancestors, Memojis are personalised caricatures, offering infinite options for customisation."),f(T,{image:q,alt:"Memoji",mdxType:"Image"}),f("p",null,"Memoji's good looks haven't gone unrecognised, and many people use static Memojis as profile pictures, or as avatars on their website. I wanted to follow suit, but by opting for the static image, you really lose their personality and liveliness. I didn't want to settle for this, and chose to explore the possibility of embedding ",f("strong",{parentName:"p"},"dynamic")," Memoji."),f("p",null,"The fact that they're fully rigged, and integrated with iOS devices' built-in face tracking technology make them perfect for the majority who don't possess the artistic aptitude to use Blender for such tasks. This can look really great however",f("sup",G({parentName:"p"},{id:"fnref-1"}),f("a",G({parentName:"sup"},{href:"#fn-1",className:"footnote-ref"}),"1")),", and should be the default first choice for anyone who's able to."),f("p",null,"They're not without their flaws however, tightly integrated into Apple's own ecosystem, Memojis and the mechanisms to create them (ie AvatarKit) are ",f("strong",{parentName:"p"},"not")," exposed outside of iMessage and FaceTime. Apple has a history of limiting the use of emojis",f("sup",G({parentName:"p"},{id:"fnref-2"}),f("a",G({parentName:"sup"},{href:"#fn-2",className:"footnote-ref"}),"2")),", and I imagine the restrictions on Memojis stem from the same corporate delusion."),f("p",null,f("strong",{parentName:"p"},"So, this is what we'll be creating:")),f("section",{className:E.memojiContainer},f(N.a,{className:E.memoji,frameCount:U,getFrameURL:W,width:Math.floor(688.5),height:Math.floor(525),mdxType:"Memoji"})),f("h2",null,"The Plan of Attack"),f("blockquote",null,f("p",{parentName:"blockquote"},f("strong",{parentName:"p"},"N.B.")," A lot of this post didn't initially work - so it's just here to document the journey."),f("p",{parentName:"blockquote"},"\u2728. Skip ahead if you're only interested in what ",f("em",{parentName:"p"},"did")," work.")),f("p",null,"Firstly let's just set out what we're trying to achieve, then we'll visit each of them in turn:"),f("ol",null,f("li",{parentName:"ol"},"Find a way of ",f("strong",{parentName:"li"},"creating")," a Memoji"),f("li",{parentName:"ol"},"Get said Memoji ",f("strong",{parentName:"li"},"into a useable format")),f("li",{parentName:"ol"},"Insert Memoji into our ",f("strong",{parentName:"li"},"website")),f("li",{parentName:"ol"},"Allow users to ",f("strong",{parentName:"li"},"interact")," with the Memoji")),f("h2",null,"Like a record baby\u2026"),f("p",null,"This is probably the simplest of the steps, although there are a few things to note."),f("p",null,"We're going to to use iMessage to create out Memoji. Importantly we want to create a ",f("em",{parentName:"p"},"video"),", not a Memoji sticker."),f(T,{image:B,alt:"iMessage",mdxType:"Image"}),f("p",null,"You want to record yourself rotating your head while keeping eye contact with the camera. The initial idea was to have the Memoji's ",f("strong",{parentName:"p"},"gaze")," following your mouse, but due to the limitations of our method, we can't converge or diverge the eyes, nor face the head straight ahead. These issues ruin the effect if we go for a 'following the mouse' type effect, so it's better to go for a 'tilting the head' type effect instead."),f("p",null,"Have a play with the finished product, and compare that with your actual head."),f("p",null,"Imagine you're holding a hula hoop in front of you with both hands, and that it's positioned so your face is inline with the centre. Now tilt your head (not your eyes) so that you're looking at the top of the hoop. Follow the hoop around 360\xb0: no problem, we're able to recreate this."),f("p",null,"Now looking at the top of the hoop again, move straight down to the bottom of the hoop without following its curvature. And the same from left to right. Repeat the same with the finished Memoji above. Notice how in real life your head moves away from the outline of the imaginary hoop, ",f("em",{parentName:"p"},"but")," how in the Memoji the head doesn't tilt to look ",f("strong",{parentName:"p"},"within")," the hoop. This is the limitation we're talking about."),f("p",null,"It's kinda okay though, your mouse isn't normally over the Memoji, so it isn't too much of an issue."),f("p",null,"Anyway, recording the video! Mimic what you see in the finished article. Start the video with your head slightly tilting up, and slowly rotate it around 360\xb0."),f(T,{image:R,alt:"Taking the Video",mdxType:"Image"}),f("p",null,"You want to try and maintain a constant distance from the camera, as you want the first and last frame to be as close together as possible to hide the fact that the motion isn't actually continuous. This took many attempts, and while the recording I settled on isn't perfect, it's good enough, and I'm not rerecording it for the 48",f("sup",{parentName:"p"},"th")," time \ud83d\ude05."),f("blockquote",null,f("p",{parentName:"blockquote"},f("strong",{parentName:"p"},"N.B.")," You'll probably find that no matter how hard you try, the raw video will never loop due to the animation added at the end."),f("p",{parentName:"blockquote"},"\ud83d\udd01 Pause for a second at the end of the recording and then trim the video to achieve the loop.")),f("h2",null,"Channel Your Inner Alpha!"),f("p",null,"Apple doesn't expose the memojis in any sort of 'raw' or 3D format. Instead, all we've got is a video. A ",f("inlineCode",{parentName:"p"},".mov"),". Straight out of my iPhone 11 and into trusty ",f("inlineCode",{parentName:"p"},"FFmpeg"),", we can see some quite detailed information about the file."),f("pre",null,f("code",G({parentName:"pre"},{}),"Input #0, mov,mp4,m4a,3gp,3g2,mj2, from '/Users/reuben/Developer/reuben.science/public/me-360t.private.mov':\n  Metadata:\n    major_brand     : qt\n    minor_version   : 0\n    compatible_brands: qt\n    creation_time   : 2020-11-24T18:30:38.000000Z\n    com.apple.quicktime.description: Memoji video, skin tone: Fairest Skin Tone 1; hairstyle: Maple, Short and straight updo with side parting; eyes: Blue;, facial hair: Flaxen, Shadow moustache and beard;\n  Duration: 00:00:05.25, start: 0.000000, bitrate: 1992 kb/s\n    Stream #0:0(und): Audio: aac (LC) (mp4a / 0x6134706D), 44100 Hz, mono, fltp, 63 kb/s (default)\n    Metadata:\n      creation_time   : 2020-11-24T18:30:38.000000Z\n      handler_name    : Core Media Audio\n    Stream #0:1(und): Video: hevc (Main) (hvc1 / 0x31637668), yuv420p(tv, bt709), 640x480, 1753 kb/s, 57.56 fps, 60 tbr, 600 tbn, 600 tbc (default)\n    Metadata:\n      creation_time   : 2020-11-24T18:30:38.000000Z\n      handler_name    : Core Media Video\n      encoder         : HEVC\n\n")),f("p",null,"Firstly we can see that we're dealing with a ",f("inlineCode",{parentName:"p"},".mov")," container holding ",f("inlineCode",{parentName:"p"},"HEVC")," aka ",f("inlineCode",{parentName:"p"},"H.265")," encoded data. This is good news: a modern-ish format that supports alpha channels. Interestingly Apple also embeds plenty of metadata about the Memoji in the file \ud83d\ude2f. Useful for an accessibility description maybe!"),f("pre",null,f("code",G({parentName:"pre"},{}),"com.apple.quicktime.description:\n    Memoji video,\n        skin tone: Fairest Skin Tone 1;\n        hairstyle: Maple, Short and straight updo with side parting;\n      eyes: Blue;\n     ,facial hair: Flaxen, Shadow moustache and beard;\n")),f("p",null,"The file format supports alpha channels! Great! Would Apple be so good as to make sure of it? Opening the file in QuickTime we can see that there is indeed an alpha channel - and its being used \ud83c\udf89."),f(T,{image:z,alt:"QuickTime",mdxType:"Image"}),f("p",null,"While the file has an alpha channel, I couldn't get ",f("inlineCode",{parentName:"p"},"FFmpeg")," to acknowledge it. Looking in the output above we only see a pixel format of ",f("inlineCode",{parentName:"p"},"yuv420p")," listed. It seems that as of now, ",f("inlineCode",{parentName:"p"},"FFmpeg"),"'s ",f("inlineCode",{parentName:"p"},"libx265")," codec doesn't support ",f("inlineCode",{parentName:"p"},"H.265")," with ",f("inlineCode",{parentName:"p"},"yuva420p")," pixel data",f("sup",G({parentName:"p"},{id:"fnref-3"}),f("a",G({parentName:"sup"},{href:"#fn-3",className:"footnote-ref"}),"3"))," - the key difference with ",f("inlineCode",{parentName:"p"},"yuv420p")," being ",f("inlineCode",{parentName:"p"},"a")," for alpha."),f("p",null,"My initial idea was to use ",f("inlineCode",{parentName:"p"},"FFmpeg")," to transcode the ",f("inlineCode",{parentName:"p"},"H.265")," into ",f("inlineCode",{parentName:"p"},"VP8"),"/",f("inlineCode",{parentName:"p"},"VP9")," given its less than stellar cross compatibility",f("sup",G({parentName:"p"},{id:"fnref-4"}),f("a",G({parentName:"sup"},{href:"#fn-4",className:"footnote-ref"}),"4")),", then I'd have support for all major browsers using both formats combined",f("sup",G({parentName:"p"},{id:"fnref-5"}),f("a",G({parentName:"sup"},{href:"#fn-5",className:"footnote-ref"}),"5")),"."),f("p",null,"While I was able to convert the ",f("inlineCode",{parentName:"p"},".mov")," to ",f("inlineCode",{parentName:"p"},".webm"),", due to ",f("inlineCode",{parentName:"p"},"FFmpeg"),"'s lack of ",f("inlineCode",{parentName:"p"},"yuva420p")," support I was loosing the alpha channel - exactly what we're trying to preserve \ud83d\ude43."),f("h2",null,"Changing Tact"),f("p",null,"Rereading the ",f("inlineCode",{parentName:"p"},"FFmpeg")," output, I noticed the ",f("inlineCode",{parentName:"p"},"handler_name")," was ",f("inlineCode",{parentName:"p"},"Core Media Video"),". That's a very 'Apple' name, and indeed it's the name of Apple's shared macOS - iOS media framework. Given that QuickTime reports it, iOS generated it, and Preview shows it, I guessed there was a fair chance that tool's I'd need to make use of the ",f("inlineCode",{parentName:"p"},"yuva420p")," alpha channel were already built in to macOS. If I could use these, then I could export the frames, and reencode them to ",f("inlineCode",{parentName:"p"},"webm")," using ",f("inlineCode",{parentName:"p"},"FFmpeg"),"."),f("p",null,"Again with Apple, this turned out to be an issue of exposing the means to the end user. QuickTime 7 used to offer the ",f("inlineCode",{parentName:"p"},"export to image sequence")," functionality",f("sup",G({parentName:"p"},{id:"fnref-6"}),f("a",G({parentName:"sup"},{href:"#fn-6",className:"footnote-ref"}),"6")),", but sometime between versions 7 and 10.6 the option was canned. QuickTime 7 isn't supported after macOS Mojave",f("sup",G({parentName:"p"},{id:"fnref-7"}),f("a",G({parentName:"sup"},{href:"#fn-7",className:"footnote-ref"}),"7"))," \ud83d\ude22. iMovie also lacks the capability. ",f("strong",{parentName:"p"},"I can confirm that Final Cut Pro X does have it though!")),f("p",null,"I don't really want to buy FCP X, and while it's only one click away if you know where to look \ud83d\udc40\u2026it's a bit overkill for such a small task."),f("h2",null,"uPVC"),f("p",null,"Given that the ",f("inlineCode",{parentName:"p"},"Core Media")," framework is built in to macOS, I decided the path of least resistance was probably to just write a quick CLI tool to extract the frames using ",f("inlineCode",{parentName:"p"},"AVFoundation")," (which uses ",f("inlineCode",{parentName:"p"},"Core Media")," under the hood). And that's exactly what I did:"),f("figure",G({},{className:"code"}),f("pre",G({parentName:"figure"},{className:"language-swift",metastring:"Swift"}),f("code",G({parentName:"pre"},{className:"language-swift",metastring:"Swift"}),"\n",f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),"\n\n",f("span",G({parentName:"code"},{className:"token keyword"}),"let")," trackReaderOutput ",f("span",G({parentName:"code"},{className:"token operator"}),"=")," ",f("span",G({parentName:"code"},{className:"token function"}),"AVAssetReaderTrackOutput"),f("span",G({parentName:"code"},{className:"token punctuation"}),"("),"track",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," videoTrack",f("span",G({parentName:"code"},{className:"token punctuation"}),",")," outputSettings",f("span",G({parentName:"code"},{className:"token punctuation"}),":"),f("span",G({parentName:"code"},{className:"token punctuation"}),"["),f("span",G({parentName:"code"},{className:"token function"}),"String"),f("span",G({parentName:"code"},{className:"token punctuation"}),"("),f("span",G({parentName:"code"},{className:"token constant"}),"kCVPixelBufferPixelFormatTypeKey"),f("span",G({parentName:"code"},{className:"token punctuation"}),")"),f("span",G({parentName:"code"},{className:"token punctuation"}),":")," ",f("span",G({parentName:"code"},{className:"token function"}),"NSNumber"),f("span",G({parentName:"code"},{className:"token punctuation"}),"("),"value",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," kCVPixelFormatType_32BGRA",f("span",G({parentName:"code"},{className:"token punctuation"}),")"),f("span",G({parentName:"code"},{className:"token punctuation"}),"]"),f("span",G({parentName:"code"},{className:"token punctuation"}),")"),"\n\n",f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),"\n\n",f("span",G({parentName:"code"},{className:"token keyword"}),"while")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"let")," sampleBuffer ",f("span",G({parentName:"code"},{className:"token operator"}),"=")," trackReaderOutput",f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token function"}),"copyNextSampleBuffer"),f("span",G({parentName:"code"},{className:"token punctuation"}),"("),f("span",G({parentName:"code"},{className:"token punctuation"}),")")," ",f("span",G({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",f("span",G({parentName:"code"},{className:"token keyword"}),"if")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"let")," imageBuffer ",f("span",G({parentName:"code"},{className:"token operator"}),"=")," ",f("span",G({parentName:"code"},{className:"token function"}),"CMSampleBufferGetImageBuffer"),f("span",G({parentName:"code"},{className:"token punctuation"}),"("),"sampleBuffer",f("span",G({parentName:"code"},{className:"token punctuation"}),")")," ",f("span",G({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",f("span",G({parentName:"code"},{className:"token keyword"}),"let")," ciimage",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," ",f("span",G({parentName:"code"},{className:"token builtin"}),"CIImage")," ",f("span",G({parentName:"code"},{className:"token operator"}),"=")," ",f("span",G({parentName:"code"},{className:"token function"}),"CIImage"),f("span",G({parentName:"code"},{className:"token punctuation"}),"("),"cvPixelBuffer",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," imageBuffer",f("span",G({parentName:"code"},{className:"token punctuation"}),")"),"\n      ",f("span",G({parentName:"code"},{className:"token keyword"}),"if")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"let")," colorSpace ",f("span",G({parentName:"code"},{className:"token operator"}),"=")," ",f("span",G({parentName:"code"},{className:"token function"}),"CGColorSpace"),f("span",G({parentName:"code"},{className:"token punctuation"}),"("),"name",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," ",f("span",G({parentName:"code"},{className:"token builtin"}),"CGColorSpace"),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),"sRGB",f("span",G({parentName:"code"},{className:"token punctuation"}),")")," ",f("span",G({parentName:"code"},{className:"token punctuation"}),"{"),"\n          ",f("span",G({parentName:"code"},{className:"token keyword"}),"let")," format ",f("span",G({parentName:"code"},{className:"token operator"}),"=")," ",f("span",G({parentName:"code"},{className:"token builtin"}),"CIFormat"),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token builtin"}),"RGBA16")," ",f("span",G({parentName:"code"},{className:"token comment"}),"// 16-bit RGBA"),"\n          ",f("span",G({parentName:"code"},{className:"token keyword"}),"let")," quality ",f("span",G({parentName:"code"},{className:"token operator"}),"=")," ",f("span",G({parentName:"code"},{className:"token number"}),"1.0")," ",f("span",G({parentName:"code"},{className:"token comment"}),"// 1.0 = lossless"),"\n\n            ",f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),"\n\n          ",f("span",G({parentName:"code"},{className:"token keyword"}),"try")," context",f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token function"}),"writePNGRepresentation"),f("span",G({parentName:"code"},{className:"token punctuation"}),"("),"of",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," ciimage",f("span",G({parentName:"code"},{className:"token punctuation"}),",")," to",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," outURL",f("span",G({parentName:"code"},{className:"token punctuation"}),",")," format",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," format",f("span",G({parentName:"code"},{className:"token punctuation"}),",")," colorSpace",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," colorSpace",f("span",G({parentName:"code"},{className:"token punctuation"}),",")," options",f("span",G({parentName:"code"},{className:"token punctuation"}),":")," ",f("span",G({parentName:"code"},{className:"token punctuation"}),"["),f("span",G({parentName:"code"},{className:"token constant"}),"kCGImageDestinationLossyCompressionQuality")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"as")," ",f("span",G({parentName:"code"},{className:"token builtin"}),"CIImageRepresentationOption"),f("span",G({parentName:"code"},{className:"token punctuation"}),":")," quality",f("span",G({parentName:"code"},{className:"token punctuation"}),"]"),f("span",G({parentName:"code"},{className:"token punctuation"}),")"),"\n      ",f("span",G({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",f("span",G({parentName:"code"},{className:"token punctuation"}),"}"),"\n  frameIndex ",f("span",G({parentName:"code"},{className:"token operator"}),"+"),f("span",G({parentName:"code"},{className:"token operator"}),"=")," ",f("span",G({parentName:"code"},{className:"token number"}),"1"),"\n",f("span",G({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),f("span",G({parentName:"code"},{className:"token punctuation"}),"."),"\n\n")),f("figcaption",{parentName:"figure"},"",f("a",G({parentName:"figcaption"},{href:"https://github.com/reubn/uPVC"}),"https://github.com/reubn/uPVC"))),f("p",null,"Written in ",f("inlineCode",{parentName:"p"},"Swift"),", it just iterates over the frames of a video file (which could theoretically be any video format supported by ",f("inlineCode",{parentName:"p"},"AVFoundation"),"), and exports ",f("inlineCode",{parentName:"p"},"16-bit RGBA")," lossless ",f("inlineCode",{parentName:"p"},"PNG"),"s. I'm not a ",f("inlineCode",{parentName:"p"},"Swift")," native, so the main logic was ",f("del",{parentName:"p"},"copied")," adapted \ud83d\udc4c from Stack Overflow",f("sup",G({parentName:"p"},{id:"fnref-8"}),f("a",G({parentName:"sup"},{href:"#fn-8",className:"footnote-ref"}),"8")),". I also ended up adding the options to export every ",f("inlineCode",{parentName:"p"},"n % x === 0"),"-th frame: for reasons I'll come on to later \ud83d\ude0f."),f("h2",null,"Return of the ",f("inlineCode",{parentName:"h2"},"FFmpeg"),"!"),f("p",null,"Armed with our sequence of image files, we're ready to merge them back into a video using ",f("inlineCode",{parentName:"p"},"FFmpeg"),"."),f("pre",G({},{className:"language-bash",metastring:"ZSH"}),f("code",G({parentName:"pre"},{className:"language-bash",metastring:"ZSH"}),"ffmpeg",f("span",G({parentName:"code"},{className:"token argument"})," -framerate")," ",f("span",G({parentName:"code"},{className:"token number"}),"60"),f("span",G({parentName:"code"},{className:"token argument"})," -i")," /Users/reuben/Developer/me/frame-%0d.png",f("span",G({parentName:"code"},{className:"token argument"})," -c:v")," libvpx-vp9",f("span",G({parentName:"code"},{className:"token argument"})," -pix_fmt")," yuva420p",f("span",G({parentName:"code"},{className:"token argument"})," -speed")," ",f("span",G({parentName:"code"},{className:"token number"}),"0"),f("span",G({parentName:"code"},{className:"token argument"})," -crf")," ",f("span",G({parentName:"code"},{className:"token number"}),"16"),f("span",G({parentName:"code"},{className:"token argument"})," -an")," /Users/reuben/Developer/me/me.webm\n")),f("p",null,f("inlineCode",{parentName:"p"},"FFmpeg")," does support ",f("inlineCode",{parentName:"p"},"yuva420p")," with ",f("inlineCode",{parentName:"p"},"webm"),", so we're good, and the file size isn't terrible - at around ",f("inlineCode",{parentName:"p"},"1MB"),"."),f("h2",null,"Rough as a Bear's Arse"),f("p",null,"All that's left now is to embed the video, and hookup ",f("inlineCode",{parentName:"p"},"mousemove")," event to scrub through the video. Surely."),f("p",null,"In Safari this works fine - buttery smooth - Chrome however really chokes on the video. I tried lowering the quality via the ",f("inlineCode",G({parentName:"p"},{className:"language-bash"}),"-crf")," parameter in ",f("inlineCode",{parentName:"p"},"FFmpeg"),", but no matter how low the quality, the FPS, or how much event handler throttling I applied, Chrome still jittered and stalled all through the animation. The same applied for ",f("inlineCode",{parentName:"p"},"VP8"),"."),f(D,{controls:!0,muted:!0,autoPlay:!0,loop:!0,video:{size:{width:677,height:370},sources:[{src:"/.assets/d05f13b4b1aba3a83466bb937920bfa0.webm",type:"video/webm"},{src:"/.assets/bf0c0fbce229c1188b5907755afd89d9.mp4",type:"video/mp4"}]},mdxType:"Video"}),f("p",null,"Given that Safari has no trouble I wonder if this is an issue of the ",f("inlineCode",{parentName:"p"},"HTML5")," ",f("inlineCode",{parentName:"p"},"video")," element's scrubbing not being optimised for animation via ",f("inlineCode",G({parentName:"p"},{className:"language-js"}),f("span",G({parentName:"inlineCode"},{className:"token punctuation"}),"."),f("span",G({parentName:"inlineCode"},{className:"token property-access"}),"currentTime")),". I also tried this in combination with ",f("inlineCode",G({parentName:"p"},{className:"language-js"}),f("span",G({parentName:"inlineCode"},{className:"token dom variable"}),"window"),f("span",G({parentName:"inlineCode"},{className:"token punctuation"}),"."),f("span",G({parentName:"inlineCode"},{className:"token property-access"}),"requestAnimationFrame"))," to no avail."),f("p",null,"Another difference between the browsers was that Safari was consuming the ",f("inlineCode",{parentName:"p"},".mov")," file, while Chrome was using the ",f("inlineCode",{parentName:"p"},".webm")," file. They both have similar file sizes, but very different compression algorithms. Most compressed video cannot be played back in reverse, or be seeked",f("sup",{parentName:"p"},"(sic)")," at realtime speeds."),f("p",null,"Imagine a zip ."),f("ul",null,f("li",{parentName:"ul"},"\ud83e\uddb7 Teeth of the zip represent video frames"),f("li",{parentName:"ul"},"\ud83d\udc4d You can unzip your coat in one direction, and it works fine."),f("li",{parentName:"ul"},"\ud83d\udc4e You can't unzip your coat in reverse - or skip bits out - leaving them zipped together."),f("li",{parentName:"ul"},"\ud83e\udd10 Picking a random point on the zip, all preceding zip must be undone in order to reach it.")),f("p",null,"Most compression works a bit like a zip (no pun intended). Keeping it simple - in video you have ",f("inlineCode",{parentName:"p"},"I frames"),", and ",f("inlineCode",{parentName:"p"},"P frames"),f("sup",G({parentName:"p"},{id:"fnref-9"}),f("a",G({parentName:"sup"},{href:"#fn-9",className:"footnote-ref"}),"9")),".",f("inlineCode",{parentName:"p"},"I frames")," are like the images that we extracted using ",f("inlineCode",{parentName:"p"},"uPVC")," - whole images in their own right. ",f("inlineCode",{parentName:"p"},"P frames")," are not bona fide images. Instead they contain references to previous ",f("inlineCode",{parentName:"p"},"I")," and ",f("inlineCode",{parentName:"p"},"P frames"),", specifying elements they have in common to save space. To decode an ",f("inlineCode",{parentName:"p"},"I frame")," you just need that frame \ud83d\udc4c. To decode a ",f("inlineCode",{parentName:"p"},"P frame")," however you also need all preceding frames that it references, and all preceding frames that all those frames reference \u2026 all the way back to the closest ",f("inlineCode",{parentName:"p"},"I frame"),f("sup",G({parentName:"p"},{id:"fnref-10"}),f("a",G({parentName:"sup"},{href:"#fn-10",className:"footnote-ref"}),"10")),". Scrubbing through the video (seeking in response to mouse movements) would require the decoder to jump around 'the zip' and necessitate 'unzipping' a lot of previous (which is ",f("strong",{parentName:"p"},"ahead")," if playing in reverse) frames / footage. Perhaps this aspect of video encoding is where some of the issues arose."),f("p",null,"This doesn't fully explain the problems as there wasn't such an issue with ",f("inlineCode",{parentName:"p"},"H.265")," in Safari - but it most probably contributed. Perhaps Chrome didn't buffer the uncompressed video into memory, while Safari did \ud83e\udd37\u200d\u2640\ufe0f."),f("h2",null,"Abort, Abort"),f("p",null,"Given that the video method wasn't going to work, I had to think of an alternative. If we run with the idea of video simply being a series frames, its not a crazy idea to skip the whole 'video' encoding malarkey and just deal with frames directly."),f("p",null,"We've already done the hard work of extracting the frames, and have a folder of ",f("inlineCode",{parentName:"p"},".png")," files."),f("p",null,"I wrote a small ",f("inlineCode",{parentName:"p"},"React")," component to listen for global ",f("inlineCode",{parentName:"p"},"mousemove")," event, and display the corresponding frame. This works great, and surprisingly is a lot smoother than video! I'm not going to go over the ins and outs of it here but I will point out a few things of note."),f("p",null,"Firstly the interactivity is a bonus, and in order to not get in the way of more pressing resources, we load the frames via a ",f("inlineCode",{parentName:"p"},"useEffect")," hook. We load a sensible ",f("inlineCode",{parentName:"p"},"defaultFrame")," first and that serves as a placeholder until the rest of them have loaded. We listen for the ",f("inlineCode",{parentName:"p"},".decode()")," ",f("inlineCode",{parentName:"p"},"Promise")," on the ",f("inlineCode",{parentName:"p"},"defaultFrame")," ",f("inlineCode",{parentName:"p"},"Image")," to signal that it's loaded and then animate it in."),f("p",null,"At this point we still don't have interactivity. That only occurs once all the frames have downloaded - to stop jitter in the first few moments. In testing it was quite common stop moving the mouse just before the point at which the frames became available. When the user then resumes mouse movement there's a jump between the ",f("inlineCode",{parentName:"p"},"defaultFrame")," placeholder and the required frame. To overcome this, we listen for the user's mouse movement even before interactivity. There isn't the option to directly query the user agent for the mouse position, so we rely on a preemptive event handler to get it - and then smoothly transition to the corresponding frame. It's better to transition when the mouse isn't moving than when it is."),f("p",null,"This works fine on traditional devices, but - for obvious reasons - works a little differently on touchscreens. We listen for the ",f("inlineCode",{parentName:"p"},"onTouch")," counterparts, but also animate the Memoji by default - as to not rely on the user touching the Memoji. Once they have, touch interaction takes over. As a next step I'd like to overlay a call-to-action to highlight this to touch users, and make the animation a little more natural."),f("p",null,"Downloading lots of (smallish) image files isn't a problem for people on fast internet connections, but consideration has to be taken for those on slower connections. The ",f("inlineCode",{parentName:"p"},"React")," component allows about ",f("inlineCode",{parentName:"p"},"5sec")," for the images to download before cancelling all but one of the requests. This allows any other more important content to come through faster, and gracefully falls back to a static Memoji."),f("h2",null,"A Little on the Large Side"),f("p",null,"Video compression may have hindered our dreams of smooth scrubbing, but it's used for a reason. The 315 frames only took up around ",f("inlineCode",{parentName:"p"},"1MB"),". Extracted in their raw ",f("inlineCode",{parentName:"p"},".png")," form they occupy a staggering ",f("inlineCode",{parentName:"p"},"65.4MB"),". Ouch \ud83d\ude33. Admittedly ",f("inlineCode",{parentName:"p"},".png")," probably isn't the most efficient format for storing high fidelity graphics, but it is lossless, and does support alpha channels: fine for an intermediate format."),f("p",null,"Firstly I saved a ",f("inlineCode",{parentName:"p"},"2/3")," of the total size by only keeping every 3",f("sup",{parentName:"p"},"rd")," frame. While perhaps counterintuitive, this didn't affect the smoothness of the final result."),f("p",null,f("inlineCode",{parentName:"p"},"ImageOptim")," managed to reduce this down size by 47%. But that's still not anywhere near what we need it to be."),f("p",null,"I settled on ",f("inlineCode",{parentName:"p"},".webp"),". Support is good and I set about converting the ",f("inlineCode",{parentName:"p"},".png")," files. The ",f("inlineCode",{parentName:"p"},"cwebp")," tool",f("sup",G({parentName:"p"},{id:"fnref-11"}),f("a",G({parentName:"sup"},{href:"#fn-11",className:"footnote-ref"}),"11"))," is the way to go, and ",f("inlineCode",{parentName:"p"},".webp")," itself has a multitude of options to when encoding the image."),f("pre",G({},{className:"language-bash",metastring:"ZSH"}),f("code",G({parentName:"pre"},{className:"language-bash",metastring:"ZSH"}),f("span",G({parentName:"code"},{className:"token keyword"}),"for")," ",f("span",G({parentName:"code"},{className:"token for-or-select variable"}),"file")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"in")," *.png",f("span",G({parentName:"code"},{className:"token punctuation"}),";")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"do")," cwebp",f("span",G({parentName:"code"},{className:"token argument"})," -lossless"),f("span",G({parentName:"code"},{className:"token argument"})," -mt")," ",f("span",G({parentName:"code"},{className:"token string"}),'"./',f("span",G({parentName:"span"},{className:"token variable"}),"$file"),'"'),f("span",G({parentName:"code"},{className:"token argument"})," -o")," ",f("span",G({parentName:"code"},{className:"token string"}),'"./',f("span",G({parentName:"span"},{className:"token variable"}),"${file",f("span",G({parentName:"span"},{className:"token operator"}),"/"),f("span",G({parentName:"span"},{className:"token operator"}),"/"),"\\.png",f("span",G({parentName:"span"},{className:"token operator"}),"/"),".webp}"),'"'),f("span",G({parentName:"code"},{className:"token punctuation"}),";")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"done"),"\n")),f("p",null," It's a really neat format and supports both ",f("inlineCode",{parentName:"p"},"lossless"),", and ",f("inlineCode",{parentName:"p"},"lossy")," compression. It even has a middle ground ",f("inlineCode",{parentName:"p"},"near_lossless")," option. Even with ",f("inlineCode",{parentName:"p"},"lossless")," compression, it managed to reduce the total burden by a massive ",f("inlineCode",{parentName:"p"},"93%")," to only ",f("inlineCode",{parentName:"p"},"4.6MB"),"! While really impressive, this is still a bit hefty, and I was hoping to dip into the ",f("inlineCode",{parentName:"p"},"KB")," range."),f("p",null," After going through many permutations I settled on a ",f("inlineCode",{parentName:"p"},"lossy")," quality of ",f("inlineCode",{parentName:"p"},"80"),". Going lower reduced the image quality, but dint't justify the cost, giving only negligible improvements in file size. I also used ",f("inlineCode",{parentName:"p"},"cwebp"),"'s builtin crop function to try and shave off ever last byte."),f("pre",G({},{className:"language-bash",metastring:"ZSH"}),f("code",G({parentName:"pre"},{className:"language-bash",metastring:"ZSH"}),f("span",G({parentName:"code"},{className:"token keyword"}),"for")," ",f("span",G({parentName:"code"},{className:"token for-or-select variable"}),"file")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"in")," *.png",f("span",G({parentName:"code"},{className:"token punctuation"}),";")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"do")," cwebp",f("span",G({parentName:"code"},{className:"token argument"})," -q")," ",f("span",G({parentName:"code"},{className:"token number"}),"80"),f("span",G({parentName:"code"},{className:"token argument"})," -mt"),f("span",G({parentName:"code"},{className:"token argument"})," -crop")," ",f("span",G({parentName:"code"},{className:"token number"}),"100")," ",f("span",G({parentName:"code"},{className:"token number"}),"26")," ",f("span",G({parentName:"code"},{className:"token number"}),"459")," ",f("span",G({parentName:"code"},{className:"token number"}),"350")," ",f("span",G({parentName:"code"},{className:"token string"}),'"./',f("span",G({parentName:"span"},{className:"token variable"}),"$file"),'"'),f("span",G({parentName:"code"},{className:"token argument"})," -o")," ",f("span",G({parentName:"code"},{className:"token string"}),'"./',f("span",G({parentName:"span"},{className:"token variable"}),"${file",f("span",G({parentName:"span"},{className:"token operator"}),"/"),f("span",G({parentName:"span"},{className:"token operator"}),"/"),"\\.png",f("span",G({parentName:"span"},{className:"token operator"}),"/"),".webp}"),'"'),f("span",G({parentName:"code"},{className:"token punctuation"}),";")," ",f("span",G({parentName:"code"},{className:"token keyword"}),"done"),"\n")),f("p",null,"After running this, and cooking an egg on my CPU, I was left with a total size of ",f("inlineCode",{parentName:"p"},"868KB"),". Pretty fucking good \ud83d\udc4c. A combined saving of just under ",f("inlineCode",{parentName:"p"},"99%"),"."),f("p",null,f("inlineCode",{parentName:"p"},".webp")," itself is based on the ",f("inlineCode",{parentName:"p"},"VP8")," video codec that we wanted to use initially. Given this, I guess the saving's aren't that surprising, and basically means that we've come full circle, just without the caveats of video compression."),f("p",null,"There are some avenues to explore to try and reduce the total file size some more. ",f("inlineCode",{parentName:"p"},".webp")," supports animation, but I don't think the ability to seek through animated images is exposed in the web environment, and it may well suffer from the same issues as ",f("inlineCode",{parentName:"p"},"VP8"),"/",f("inlineCode",{parentName:"p"},"VP9"),". Maybe serving the frames as an animated ",f("inlineCode",{parentName:"p"},".webp")," file and then decoding them to canvas is an option - but I am yet to explore the possibility."),f("p",null,"A simpler option might be to combine the frames into sprite sheet, but I haven't tested if the compression benefits would outweigh the parallel downloads we achieve by serving frames separately."),f("h2",null,"Are we nearly there yet?"),f("p",null,"While what we have works, it still has a number of caveats, chiefly the ",f("inlineCode",{parentName:"p"},"868KB")," file size burden, and the limited axises the Memoji is able to move in. I'd still like to reduce the former, and to summarise, the avenues I'm currently thinking of exploring are:"),f("ul",null,f("li",{parentName:"ul"},"Animated ",f("inlineCode",{parentName:"li"},".webp")," frames decoded to ",f("inlineCode",{parentName:"li"},"canvas")),f("li",{parentName:"ul"},"Sprite sheets"),f("li",{parentName:"ul"},f("inlineCode",{parentName:"li"},".avif")," once support is good enough")),f("p",null,"The latter is more difficult, and would require a completely new approach. While the ",f("inlineCode",{parentName:"p"},"AvatarKit")," framework isn't officially exposed, people have managed to use it on side loaded apps",f("sup",G({parentName:"p"},{id:"fnref-12"}),f("a",G({parentName:"sup"},{href:"#fn-12",className:"footnote-ref"}),"12")),". The 3D models are also stored at a known location",f("sup",G({parentName:"p"},{id:"fnref-13"}),f("a",G({parentName:"sup"},{href:"#fn-13",className:"footnote-ref"}),"13")),", extracting them shouldn't be difficult, but I have very little knowledge of how to composite the features into 'me', nor do I know how animating them would work. If this were to be possible, then it would solve the current limitations on movement - ",f("em",{parentName:"p"},"and")," - via ",f("inlineCode",{parentName:"p"},"WebGL")," the issues with file size."),f("div",G({},{className:"footnotes"}),f("hr",{parentName:"div"}),f("ol",{parentName:"div"},f("li",G({parentName:"ol"},{id:"fn-1","ref-number":"1"}),f("a",G({parentName:"li"},{href:"https://www.joshwcomeau.com/"}),"https://www.joshwcomeau.com/"),f("a",G({parentName:"li"},{href:"#fnref-1",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-2","ref-number":"2"}),f("a",G({parentName:"li"},{href:"https://twitter.com/Sam0711er/status/959535639174746112"}),"https://twitter.com/Sam0711er/status/959535639174746112"),f("a",G({parentName:"li"},{href:"#fnref-2",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-3","ref-number":"3"}),f("a",G({parentName:"li"},{href:"https://trac.ffmpeg.org/ticket/7965"}),"https://trac.ffmpeg.org/ticket/7965"),f("a",G({parentName:"li"},{href:"#fnref-3",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-4","ref-number":"4"}),f("a",G({parentName:"li"},{href:"https://caniuse.com/hevc"}),"https://caniuse.com/hevc"),f("a",G({parentName:"li"},{href:"#fnref-4",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-5","ref-number":"5"}),f("a",G({parentName:"li"},{href:"https://caniuse.com/webm"}),"https://caniuse.com/webm"),f("a",G({parentName:"li"},{href:"#fnref-5",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-6","ref-number":"6"}),f("a",G({parentName:"li"},{href:"https://video.stackexchange.com/questions/4033/exporting-mov-vr-to-multiple-still-frames"}),"https://video.stackexchange.com/questions/4033/exporting-mov-vr-to-multiple-still-frames"),f("a",G({parentName:"li"},{href:"#fnref-6",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-7","ref-number":"7"}),f("a",G({parentName:"li"},{href:"https://support.apple.com/kb/DL923?locale=en_GB"}),"https://support.apple.com/kb/DL923?locale=en_GB"),f("a",G({parentName:"li"},{href:"#fnref-7",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-8","ref-number":"8"}),f("a",G({parentName:"li"},{href:"https://stackoverflow.com/questions/39570745/accesing-individual-frames-using-av-player/39573702#39573702"}),"https://stackoverflow.com/questions/39570745/accesing-individual-frames-using-av-player/39573702#39573702"),f("a",G({parentName:"li"},{href:"#fnref-8",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-9","ref-number":"9"}),f("a",G({parentName:"li"},{href:"https://en.m.wikipedia.org/wiki/Video_compression_picture_types"}),"https://en.m.wikipedia.org/wiki/Video_compression_picture_types"),f("a",G({parentName:"li"},{href:"#fnref-9",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-10","ref-number":"10"}),f("a",G({parentName:"li"},{href:"https://github.com/google/ExoPlayer/issues/2191#issuecomment-266783472"}),"https://github.com/google/ExoPlayer/issues/2191#issuecomment-266783472"),f("a",G({parentName:"li"},{href:"#fnref-10",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-11","ref-number":"11"}),f("a",G({parentName:"li"},{href:"https://developers.google.com/speed/webp/docs/cwebp"}),"https://developers.google.com/speed/webp/docs/cwebp"),f("a",G({parentName:"li"},{href:"#fnref-11",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-12","ref-number":"12"}),f("a",G({parentName:"li"},{href:"https://github.com/simonbs/SBSAnimoji"}),"https://github.com/simonbs/SBSAnimoji"),f("a",G({parentName:"li"},{href:"#fnref-12",className:"footnote-backref"}),"\u21a9")),f("li",G({parentName:"ol"},{id:"fn-13","ref-number":"13"}),f("a",G({parentName:"li"},{href:"https://www.reddit.com/r/jailbreak/comments/j2rxd5/question_is_there_a_way_to_ripexport/"}),"https://www.reddit.com/r/jailbreak/comments/j2rxd5/question_is_there_a_way_to_ripexport/"),f("a",G({parentName:"li"},{href:"#fnref-13",className:"footnote-backref"}),"\u21a9")))))}K.isMDXComponent=!0},MIZt:function(e,t,a){e.exports={memoji:"styles_memoji__3jDkc",notReady:"styles_notReady__NraKJ",ready:"styles_ready__2UrBZ"}},RujP:function(e,t,a){e.exports={memojiContainer:"styles_memojiContainer__1_1o6",memoji:"styles_memoji__3KGIr"}},ck7P:function(e,t,a){"use strict";var n=a("rePB"),o=a("o0o1"),r=a.n(o);function i(e,t,a,n,o,r,i){try{var s=e[r](i),p=s.value}catch(l){return void a(l)}s.done?t(p):Promise.resolve(p).then(n,o)}function s(e){return function(){var t=this,a=arguments;return new Promise((function(n,o){var r=e.apply(t,a);function s(e){i(r,n,o,s,p,"next",e)}function p(e){i(r,n,o,s,p,"throw",e)}s(void 0)}))}}var p=a("Ff2n"),l=a("nKUr"),c=a("q1tI"),m=a("MIZt");function u(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function d(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?u(Object(a),!0).forEach((function(t){Object(n.a)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):u(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}t.a=function(e){var t=e.frameCount,a=e.getFrameURL,n=e.defaultFrameNumber,o=void 0===n?Math.floor(t/2):n,i=e.width,u=e.height,h=e.className,f=Object(p.a)(e,["frameCount","getFrameURL","defaultFrameNumber","width","height","className"]),N=Object(c.useRef)(null),b=Object(c.useRef)([]).current,g=Object(c.useRef)({}).current,y=Object(c.useState)(!1),w=y[0],v=y[1],k=Object(c.useState)(!1),j=k[0],C=k[1],O=Object(c.useState)(!1),I=O[0],x=O[1],P=function(e){if(b[e])return b[e];var t=new Image;return t.src=a(e),t},S=function(){var e=s(r.a.mark((function e(){var a,n,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return C(!0),M(P(o)).then((function(){return x(!0)})),a=Array.from({length:t},(function(e,t){return P(t)})),n=setTimeout((function(){a.forEach((function(e,t){return t!==o&&(e.src="")})),a=null}),5e3),i=Promise.all(a.map(function(){var e=s(r.a.mark((function e(t,a){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,M(t);case 2:return e.abrupt("return",b[a]=e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}())).then((function(e){return clearTimeout(n),e})),e.abrupt("return",a?i:null);case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),M=function(){var e=s(r.a.mark((function e(t){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t;case 2:return e.next=4,e.sent.decode();case 4:return e.abrupt("return",t);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),_=function(e){if(e&&N.current){var t=N.current.getContext("2d"),a=N.current.width/2-e.width/2,n=N.current.height/2-e.height/2;t.clearRect(a,n,e.width,e.height),t.drawImage(e,a,n)}},T=function(e){var a=e.mx,n=e.my,o=e.cx,r=e.cy,i=e.fraction,s=void 0===i?null:i;if(null===s){var p=o-a,l=r-n,c=Math.atan2(p,-l);s=(2*Math.PI+c)%(2*Math.PI)/(2*Math.PI)}return Math.floor(Math.max(Math.min(s*t,t),0))},A=function(e){var t=e.mx,a=e.my,n=e.cx,o=e.cy,r=e.fraction,i=T({mx:t,my:a,cx:n,cy:o,fraction:void 0===r?null:r});window.requestAnimationFrame((function(){return _(b[i])}))},F=function(){var e=N.current.getBoundingClientRect(),t=e.x,a=e.y;return{mx:t+e.width/2,my:a+e.height/2}};return Object(c.useEffect)((function(){console.log({singleFrameReady:I,ready:w,framesLoading:j});N.current;var e=F();e.mx,e.my;if(j||S().then((function(){return v(!0)})).then(s(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=_,e.next=3,M(P(o));case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))),I&&_(b[o]),w)try{!function(e){var t=e.fr,a=e.to;if(!isNaN(a))var n=a>t?1:-1,o=(Math.abs(a-t),t),r=setInterval((function(){if(o+=n,-1===n&&o<a||1===n&&o>a)return clearInterval(r);window.requestAnimationFrame((function(){return _(b[o])}))}),7)}({fr:o,to:T(d(d({},F()),g))})}catch(m){}var t=function(e){var t=e.clientX,a=e.clientY;if(!w)return g.cx=t,void(g.cy=a);A(d(d({},F()),{},{cx:t,cy:a}))},a=!1;if("ontouchstart"in window&&!a){var n=0,i=1,p=setInterval((function(){return A({fraction:n=(n+1+.01*i*Math.random())%1})}),10),l=setInterval((function(){return i*=Math.random()>.5?-1:1}),2e3),c=function(e){var n=e.changedTouches[0],o=n.clientX,r=n.clientY;a=!0,clearInterval(p),clearInterval(l),t({clientX:o,clientY:r}),e.preventDefault()};return N.current.addEventListener("touchstart",c,!1),N.current.addEventListener("touchmove",c,!1),function(){clearInterval(p),clearInterval(l),N.current&&(N.current.removeEventListener("touchstart",c,!1),N.current.removeEventListener("touchmove",c,!1))}}return window.addEventListener("mousemove",t),function(){return window.removeEventListener("mousemove",t)}}),[w,I,j]),Object(l.jsx)("canvas",d(d({},f),{},{className:[m.memoji,h||"",w||I?m.ready:m.notReady].join(" "),ref:N,width:i,height:u}))}},v8yT:function(e,t,a){e.exports={loading:"styles_loading__1HQrJ"}},vU6x:function(e,t,a){e.exports={loading:"styles_loading__12PPP"}}}]);